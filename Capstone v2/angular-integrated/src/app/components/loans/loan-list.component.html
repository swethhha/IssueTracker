<div class="dashboard-container">
  <div class="dashboard-header">
    <div class="header-content">
      <h1 class="dashboard-title">Loan Management</h1>
      <p class="dashboard-description">Apply for loans and track your applications</p>
    </div>
  </div>

  <div class="card">
      <!-- Apply for Loan Button -->
      <div class="mb-3" *ngIf="canApply()">
        <button class="btn btn-primary" (click)="toggleForm()">
          <i class="feather icon-plus"></i>
          {{ showForm ? 'Cancel' : 'Apply for Loan' }}
        </button>
      </div>

      <!-- Loan Application Form -->
      <div class="card mb-4" *ngIf="showForm">
        <div class="card-header">
          <h5>Loan Application</h5>
        </div>
        <div class="card-body">
          <form [formGroup]="loanForm" (ngSubmit)="onSubmit()">
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="loanType">Loan Type</label>
                  <select class="form-control" id="loanType" formControlName="loanType">
                    <option value="">Select Loan Type</option>
                    <option value="Personal">Personal Loan</option>
                    <option value="Home">Home Loan</option>
                    <option value="Car">Car Loan</option>
                    <option value="Education">Education Loan</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="amount">Amount</label>
                  <input type="number" class="form-control" id="amount" formControlName="amount" placeholder="Enter amount">
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="duration">Duration (months)</label>
                  <input type="number" class="form-control" id="duration" formControlName="duration" placeholder="6-60 months">
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="reason">Reason</label>
                  <input type="text" class="form-control" id="reason" formControlName="reason" placeholder="Reason for loan">
                </div>
              </div>
            </div>
            
            <!-- Document Upload Section -->
            <div class="form-group">
              <h6 class="mb-3">Required Documents</h6>
              
              <div class="mb-3">
                <label class="form-label">Identity Proof (Aadhaar/PAN/Passport)</label>
                <input type="file" class="form-control" accept=".pdf,.jpg,.jpeg,.png" (change)="onFileSelect($event, 'identity')">
                <small class="text-muted">Upload Aadhaar Card, PAN Card, or Passport</small>
              </div>

              <div class="mb-3">
                <label class="form-label">Address Proof</label>
                <input type="file" class="form-control" accept=".pdf,.jpg,.jpeg,.png" (change)="onFileSelect($event, 'address')">
                <small class="text-muted">Utility Bill, Rental Agreement, or Passport</small>
              </div>

              <div class="mb-3">
                <label class="form-label">Bank Statement (Last 6 months)</label>
                <input type="file" class="form-control" accept=".pdf" (change)="onFileSelect($event, 'bankStatement')">
                <small class="text-muted">PDF format preferred</small>
              </div>

              <div class="mb-3" *ngIf="loanForm.get('loanType')?.value !== 'Personal'">
                <label class="form-label">Supporting Document</label>
                <input type="file" class="form-control" accept=".pdf,.jpg,.jpeg,.png" (change)="onFileSelect($event, 'supporting')">
                <small class="text-muted">
                  <span *ngIf="loanForm.get('loanType')?.value === 'Education'">Admission letter or Fee structure</span>
                  <span *ngIf="loanForm.get('loanType')?.value === 'Medical'">Hospital bills or Doctor's certificate</span>
                  <span *ngIf="loanForm.get('loanType')?.value === 'Emergency'">Incident supporting bills</span>
                </small>
              </div>

              <!-- Selected Files Display -->
              <div class="mt-3" *ngIf="selectedDocuments.length > 0">
                <h6>Selected Documents:</h6>
                <div class="list-group">
                  <div *ngFor="let doc of selectedDocuments; let i = index" 
                       class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                      <i class="feather icon-file me-2"></i>
                      <strong>{{ doc.type }}:</strong> {{ doc.file.name }}
                      <small class="text-muted d-block">{{ (doc.file.size / 1024 / 1024).toFixed(2) }} MB</small>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" (click)="removeDocument(i)">
                      <i class="feather icon-x"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="form-group">
              <button type="submit" class="btn btn-success" [disabled]="loanForm.invalid || submitting || selectedDocuments.length < 3">
                <span *ngIf="submitting" class="spinner-border spinner-border-sm me-2"></span>
                {{ submitting ? 'Submitting...' : 'Submit Application' }}
              </button>
              <small class="text-muted d-block mt-2" *ngIf="selectedDocuments.length < 3">
                Please upload at least Identity Proof, Address Proof, and Bank Statement
              </small>
            </div>
          </form>
        </div>
      </div>

      <!-- Loading State -->
      <div class="text-center" *ngIf="loading">
        <app-spinner></app-spinner>
        <p>Loading loans...</p>
      </div>

      <!-- Error State -->
      <div class="alert alert-danger" *ngIf="error">
        <i class="feather icon-alert-circle"></i>
        {{ error }}
        <button class="btn btn-sm btn-outline-danger ml-2" (click)="loadLoans()">
          Retry
        </button>
      </div>

      <!-- Loans Table -->
      <div class="table-responsive" *ngIf="!loading && !error">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Loan Type</th>
              <th>Amount</th>
              <th>Duration</th>
              <th>Monthly EMI</th>
              <th>Reason</th>
              <th>Applied Date</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let loan of loans">
              <td>{{ loan.loanType }}</td>
              <td>{{ loan.amount | currency:'USD':'symbol':'1.2-2' }}</td>
              <td>{{ loan.duration }} months</td>
              <td>N/A</td>
              <td>{{ loan.reason }}</td>
              <td>{{ loan.applicationDate | date:'MMM dd, yyyy' }}</td>
              <td>
                <span class="badge" [ngClass]="getStatusClass(loan.status)">
                  {{ loan.status }}
                </span>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Empty State -->
        <div class="text-center py-4" *ngIf="loans.length === 0">
          <i class="feather icon-credit-card" style="font-size: 48px; color: #ccc;"></i>
          <h5 class="mt-3">No loans found</h5>
          <p class="text-muted">You haven't applied for any loans yet.</p>
          <button class="btn btn-primary" (click)="toggleForm()" *ngIf="canApply()">
            Apply for Loan
          </button>
        </div>
      </div>
  </div>
</div>